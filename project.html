<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="doc-title">Project — Jarne Beaufays</title>
  <meta name="description" content="Project details" id="meta-desc" />
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css">
  <link rel="stylesheet" href="theme.css">
  <script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>

  <style>
    .glightbox-clean .gslide-image img {
      width: 90vw !important;
      height: 90vh !important;
      object-fit: contain;
      border-radius: 8px;
    }
    .glightbox-container .ginner-container {
      padding: 20px;
    }
  </style>

  <style>
    /* Masonry helpers */
    #gallery > a {
      display: block;
      margin-bottom: 1rem;                 /* vertical spacing between items */
      break-inside: avoid;                 /* prevent column breaks inside items */
      -webkit-column-break-inside: avoid;  /* Safari */
      page-break-inside: avoid;            /* Print fallback */
    }
    #gallery img {
      width: 100%;
      height: auto;   /* keep natural aspect ratio */
      display: block;
      border-radius: 0.5rem;
    }
  </style>
</head>

<body class="antialiased text-slate-800" aria-busy="true">
  <!-- Loading overlay (visible until JSON is parsed & page populated) -->
  <div id="loadingOverlay"
       class="fixed inset-0 z-[9999] flex flex-col items-center justify-center gap-4
              bg-white/95 backdrop-blur-sm transition-opacity duration-300">
    <div class="h-10 w-10 rounded-full border-4 border-slate-300 border-t-slate-700 animate-spin"
         aria-hidden="true"></div>
    <p class="text-sm text-slate-600" role="status" aria-live="polite">Loading project…</p>
    <noscript><p class="text-xs text-slate-500">Enable JavaScript to load this page.</p></noscript>
  </div>

  <!-- Header / Hero (filled by JS) -->
  <header class="relative text-white">
    <div id="hero" class="hero-clip bg-[var(--color-accent1)]">
      <div class="max-w-7xl mx-auto px-6 py-12 lg:py-16">
        <a href="index.html" class="inline-block mb-6 text-white/90 hover:underline">&larr; Back to
          portfolio</a>
        <div class="grid lg:grid-cols-2 gap-8 items-center">
          <div>
            <h1 id="title" class="text-3xl sm:text-4xl font-extrabold tracking-tight leading-tight">Loading…</h1>
            <p id="subtitle" class="mt-2 text-md opacity-90"></p>
            <div id="tags" class="mt-4 flex flex-wrap gap-2"></div>
          </div>
          <div class="flex justify-end">
            <img id="heroImg" alt=""
                 class="w-full max-w-xl rounded-xl ring-8 ring-white shadow-lg object-cover">
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main id="mainContent" class="max-w-7xl mx-auto px-6 py-10">
    <!-- Two-column content wrapper (text on left, links on right) -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
      <div id="leftCol" class="lg:col-span-2 space-y-10"></div>
      <div id="rightCol" class="lg:col-span-1 space-y-10">
        <div id="playableWrap" class="w-full max-w-lg mx-auto hidden">
          <iframe 
            src="Ads/pepsi.html" 
            width="100%" 
            height="600" 
            frameborder="0" 
            allow="muted"
            scrolling="no">
          </iframe>
          A playable ad for Pepsi I made. This is a special muted build.
        </div>
      </div>
    </div>

    <!-- Gallery (always at the bottom) -->
    <section id="galleryWrap" class="hidden mt-12">
      <h2 class="text-xl font-semibold mb-4">Gallery</h2>
      <div id="gallery" class="columns-1 sm:columns-2 lg:columns-3 gap-4"></div>
    </section>
  </main>

  <footer class="relative text-white">
    <div id="footer" class="footer-clip bg-[var(--color-accent1)]">
      <div class="max-w-5xl mx-auto px-6 py-10 text-sm">
        <span class="opacity-90">&copy; Jarne Beaufays — <span id="year">2025</span></span>
      </div>
    </div>
  </footer>

  <script>
    (async function () {
      const overlay = document.getElementById('loadingOverlay');
      const hideLoading = () => {
        overlay?.classList.add('opacity-0');
        setTimeout(() => overlay?.classList.add('hidden'), 250);
        document.body.removeAttribute('aria-busy');
      };

      const params = new URLSearchParams(location.search);
      const slug = params.get('slug');

      const fail = (msg) => {
        document.getElementById('title').textContent = 'Not found';
        document.getElementById('subtitle').textContent = msg;
        document.getElementById('doc-title').textContent = `Not found — Jarne Beaufays`;
        document.getElementById('meta-desc').setAttribute('content', 'Project not found');
        document.getElementById('heroImg').style.display = 'none';
      };

      try {
        const res = await fetch('projects.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('Failed to load data');

        const projects = await res.json();
        const project = projects.find(p => p.slug === slug);
        if (!project) {
          fail('No project matches "' + slug + '".');
          return;
        }

        // ---- Basic fields ----
        document.getElementById('doc-title').textContent = `${project.title} — Jarne Beaufays`;

        // Meta description: prefer project.short, else first text section, else title
        const firstTextSection = Array.isArray(project.sections)
          ? project.sections.find(s =>
              typeof s?.content === 'string' && s.content.trim().length ||
              (s?.content && typeof s.content === 'object' && typeof s.content.text === 'string' && s.content.text.trim().length)
            )
          : null;
        const metaDesc = project.short
          || (typeof firstTextSection?.content === 'string' ? firstTextSection.content : firstTextSection?.content?.text)
          || project.title;
        document.getElementById('meta-desc').setAttribute('content', metaDesc);

        document.getElementById('title').textContent = project.title;
        document.getElementById('subtitle').textContent = [project.client, project.year].filter(Boolean).join(' • ');
        document.getElementById('year').textContent = new Date().getFullYear();

        // Hero image
        const heroImg = document.getElementById('heroImg');
        heroImg.src = project.hero || project.thumb || '';
        heroImg.alt = project.title;

        // Tags
        const tagsWrap = document.getElementById('tags');
        const tagsData = Array.isArray(project.tags)
          ? project.tags.filter(t => typeof t === 'string' && t.trim().length)
          : [];
        tagsWrap.innerHTML = '';
        tagsData.forEach(t => {
          const s = document.createElement('span');
          s.className = "cat-pill-inverted inline-block text-xs px-3 py-1 rounded-full";
          s.textContent = t;
          tagsWrap.appendChild(s);
        });

        // Accent color by type
        const type = (project.type ?? '').toString();
        const color = `var(${
          type === "Industry Projects" ? "--color-accent1"
            : type === "Industry Prototypes" ? "--color-accent3"
            : type === "Personal Projects" ? "--color-accent4"
            : "--color-accent2"
        })`;
        document.getElementById("hero").style.backgroundColor = color;
        document.getElementById("footer").style.backgroundColor = color;

        // ---- Column helpers ----
        const leftCol = document.getElementById('leftCol');
        const rightCol = document.getElementById('rightCol');

        const makeTextBlock = (title, html) => {
          const sec = document.createElement('section');
          const h2 = document.createElement('h2');
          h2.className = "text-xl font-semibold mb-3";
          h2.textContent = title;
          sec.appendChild(h2);

          const div = document.createElement('div');
          div.className = "text-slate-700 leading-relaxed";
          div.innerHTML = html;
          sec.appendChild(div);
          return sec;
        };

        const makeLinksBlock = (title, linksArr) => {
          const sec = document.createElement('section');
          const h2 = document.createElement('h2');
          h2.className = "text-xl font-semibold mb-3";
          h2.textContent = title;
          sec.appendChild(h2);

          const wrap = document.createElement('div');
          wrap.className = "flex flex-wrap gap-2";
          linksArr.forEach(l => {
            if (!l || !l.href || !l.label) return;
            const a = document.createElement('a');
            a.href = l.href;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            // Inline buttons that wrap; not full-width
            a.className = "inline-flex items-center justify-center px-3 py-2 rounded-md text-sm font-semibold bg-[var(--color-accent1)] hover:bg-[var(--color-accent3)] text-white";
            a.textContent = l.label;
            wrap.appendChild(a);
          });
          sec.appendChild(wrap);
          return sec;
        };

        // ---- Dynamic Sections (split across two columns) ----
        if (Array.isArray(project.sections)) {
          project.sections.forEach(sec => {
            if (!sec || !sec.title || !sec.content) return;

            // TEXT on left
            if (typeof sec.content === 'string') {
              leftCol.appendChild(makeTextBlock(sec.title, sec.content));
            }
            // LINKS on right
            else if (Array.isArray(sec.content)) {
              rightCol.appendChild(makeLinksBlock(sec.title, sec.content));
            }
            // MIXED object { text?, links? }
            else if (sec.content && typeof sec.content === 'object') {
              const textHtml = typeof sec.content.text === 'string' ? sec.content.text : '';
              const linksArr = Array.isArray(sec.content.links) ? sec.content.links : [];
              if (textHtml) leftCol.appendChild(makeTextBlock(sec.title, textHtml));
              if (linksArr.length) rightCol.appendChild(makeLinksBlock(sec.title, linksArr));
            }
          });
        }

        // ---- Reveal playable ad only if title contains "Activision" ----
        const playableWrap  = document.getElementById('playableWrap');
        if (project.title.toLowerCase().includes('activision')) {
          playableWrap.classList.remove('hidden');
          playableWrap.parentNode.appendChild(playableWrap);
        }

       // ---- Gallery (always last) ----
        const gallerySources = Array.isArray(project.gallery) ? project.gallery.filter(Boolean) : [];
        const grid = document.getElementById('gallery');
        grid.innerHTML = '';

        if (gallerySources.length) {
          gallerySources.forEach((src, i) => {
            const a = document.createElement('a');
            a.href = src;
            a.className = "mb-4"; // spacing; break-inside handled in CSS above
            a.setAttribute('data-gallery', 'project');
            a.setAttribute('aria-label', `${project.title} — image ${i + 1}`);

            const img = document.createElement('img');
            img.src = src;
            img.alt = `${project.title} — image ${i + 1}`;
            img.loading = 'lazy';

            a.appendChild(img);
            grid.appendChild(a);
          });

          document.getElementById('galleryWrap').classList.remove('hidden');

          // (Re)initialize GLightbox
          if (!window._glb) {
            window._glb = GLightbox({ selector: '#gallery a' });
          } else if (typeof window._glb.reload === 'function') {
            window._glb.reload();
          } else {
            window._glb = GLightbox({ selector: '#gallery a' });
          }
        } else {
          document.getElementById('galleryWrap').classList.add('hidden');
        }

      } catch (e) {
        console.error(e);
        fail('There was a problem loading the project data.');
      } finally {
        hideLoading();
      }
    })();
  </script>
</body>
</html>
